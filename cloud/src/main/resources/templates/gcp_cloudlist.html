<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>XamOps - GCP Cloudlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <div th:replace="~{fragments/_sidebar :: sidebar}"></div>
        <main class="flex-1 flex flex-col p-6" x-data="gcpCloudlist()">
            <header class="flex-shrink-0 mb-6">
                <h1 class="text-2xl font-bold text-gray-800">GCP Cloudlist</h1>
                <p class="text-sm text-gray-500">All discovered resources for Project ID: <span x-text="accountId" class="font-semibold text-gray-700"></span></p>
            </header>
            
            <div class="w-full bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b">
                     <input type="text" x-model="searchTerm" placeholder="Search resources..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Name</th>
                                <th scope="col" class="px-6 py-3">Type</th>
                                <th scope="col" class="px-6 py-3">Location</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="isLoading">
                                <tr class="bg-white border-b animate-pulse" x-ref="loading" x-init="$el.setAttribute('x-for', 'i in 5')">
                                    <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded"></div></td>
                                </tr>
                            </template>
                            <template x-for="resource in filteredResources" :key="resource.id">
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 font-medium text-gray-900" x-text="resource.name"></td>
                                    <td class="px-6 py-4" x-text="resource.type"></td>
                                    <td class="px-6 py-4" x-text="resource.location"></td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-800': resource.status === 'RUNNING' || resource.status === 'ACTIVE',
                                                  'bg-red-100 text-red-800': resource.status === 'TERMINATED',
                                                  'bg-gray-100 text-gray-800': resource.status !== 'RUNNING' && resource.status !== 'ACTIVE' && resource.status !== 'TERMINATED'
                                              }"
                                              x-text="resource.status">
                                        </span>
                                    </td>
                                </tr>
                            </template>
                             <template x-if="!isLoading && filteredResources.length === 0">
                                <tr>
                                    <td colspan="4" class="text-center py-12 text-gray-500">
                                        <p class="font-semibold">No resources found.</p>
                                        <p class="text-sm">No resources match your current search term or filters.</p>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        function gcpCloudlist() {
            return {
                isLoading: true,
                accountId: sessionStorage.getItem('selectedAccountId'),
                resources: [],
                searchTerm: '',
                init() {
                    if (!this.accountId) {
                        this.isLoading = false;
                        console.error("No GCP Project ID selected.");
                        return;
                    }
                    this.fetchResources();
                },
                fetchResources() {
                    this.isLoading = true;
                    fetch(`/api/gcp/cloudlist/resources?accountId=${this.accountId}`)
                        .then(res => res.json())
                        .then(data => {
                            this.resources = data;
                        })
                        .catch(err => console.error('Failed to load GCP resources:', err))
                        .finally(() => this.isLoading = false);
                },
                get filteredResources() {
                    if (this.searchTerm === '') {
                        return this.resources;
                    }
                    return this.resources.filter(res => 
                        (res.name && res.name.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
                        (res.type && res.type.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
                        (res.id && res.id.toLowerCase().includes(this.searchTerm.toLowerCase()))
                    );
                }
            }
        }
    </script>
</body>
</html>
