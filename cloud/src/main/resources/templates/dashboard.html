<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Live AWS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Updated Alpine.js CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/custom/world.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        [x-cloak] { display: none !important; }
        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #e5e7eb; }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        /* Styles for interactive KPI cards */
        .kpi-card {
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05); 
        }
        .kpi-card .main-content {
            transition: opacity 0.3s ease-in-out;
        }
        .kpi-card:hover .main-content {
            opacity: 0;
        }
        .kpi-card .sparkline-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .kpi-card:hover .sparkline-container {
            opacity: 1;
        }

        /* Styles for pulsing AI Advisor icon */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }
    </style>
</head>
<body x-data="dashboardApp()">

    <div id="errorState" class="hidden fixed inset-0 flex items-center justify-center bg-red-50 text-red-700 z-50">
        <div><h2 class="text-2xl font-bold">Error</h2><p id="errorMessage"></p></div>
    </div>

    <div x-show="isModalOpen" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-40" @click.away="isModalOpen = false">
        <div class="relative mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-xl bg-white" @click.stop>
            <div class="flex justify-between items-center pb-3 border-b">
                <div>
                    <p class="text-2xl font-bold" x-text="modalTitle"></p>
                    <p class="text-sm font-mono text-gray-500" x-text="modalResourceId"></p>
                </div>
                <button @click="isModalOpen = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="mt-4 h-96">
                <canvas id="metricsChart"></canvas>
            </div>
        </div>
    </div>

    <div id="appBody" class="flex">
        <aside class="fixed top-0 left-0 h-screen w-64 bg-white border-r border-gray-200 z-20">
            <div th:replace="~{fragments/_sidebar :: sidebar}"></div>
        </aside>

         <div class="ml-64 flex-1">
             <main class="flex-1 p-6 bg-gray-50 space-y-6">
                <header class="h-16 flex items-center justify-between bg-white px-6 -mx-6 -mt-6 mb-6 border-b sticky top-0 z-10">
                    <div>
                        <h1 class="text-xl font-semibold text-gray-800">Live Dashboard</h1>
                        <p id="updateTime" class="text-xs text-gray-500"></p>
                    </div>
                    <button id="refreshButton" @click="fetchDashboardData(true)" class="flex items-center text-sm text-indigo-600 hover:text-indigo-800" :disabled="isLoading">
                        <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': isLoading}"></i>
                        <span x-text="isLoading ? 'Refreshing...' : 'Refresh'"></span>
                    </button>
                </header>

                <div id="unselectedState" class="hidden text-center py-24">
                    <i class="fas fa-mouse-pointer fa-4x text-gray-400"></i>
                    <h3 class="mt-4 text-lg font-semibold text-gray-700">Welcome to XamOps</h3>
                    <p class="text-gray-500">Please select an account from the sidebar to view its dashboard.</p>
                </div>

                <div x-show="isLoading" id="dashboardSkeleton" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border h-28 skeleton"></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border h-28 skeleton"></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border h-28 skeleton"></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border h-28 skeleton"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm h-96 skeleton"></div>
                    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm h-48 skeleton"></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm h-48 skeleton"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm h-64 skeleton"></div>
                </div>

                <div x-show="!isLoading" id="dashboardContent" class="hidden space-y-6">
                    <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-indigo-200">
                        <h3 class="font-semibold text-gray-700 flex items-center mb-3">
                            <div class="relative mr-3">
                                <i class="fas fa-wand-magic-sparkles text-indigo-500"></i>
                                <span x-show="ai.pulse" class="absolute top-0 left-0 -ml-1 -mt-1 h-3 w-3 rounded-full bg-indigo-400 animate-pulse-glow"></span>
                            </div>
                            AI Smart Advisor
                        </h3>
                        <div x-show="ai.isLoading" class="space-y-2">
                            <div class="h-4 bg-gray-200 rounded w-full animate-pulse"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6 animate-pulse"></div>
                            <div class="h-4 bg-gray-200 rounded w-3/4 animate-pulse"></div>
                        </div>
                        <div x-show="!ai.isLoading && ai.summary" x-cloak>
                            <div class="text-gray-600 text-sm leading-relaxed bg-indigo-50 p-4 rounded-md" x-html="ai.summary"></div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <template x-for="action in ai.actions" :key="action.text">
                                    <button @click="handleAiAction(action)" class="px-3 py-1.5 text-xs font-semibold text-indigo-700 bg-indigo-100 rounded-full hover:bg-indigo-200 transition">
                                        <span x-text="action.text"></span> <i class="fas fa-arrow-right ml-1.5 text-xs"></i>
                                    </button>
                                </template>
                            </div>
                        </div>
                        <div x-show="!ai.isLoading && ai.error" x-cloak class="text-red-600 text-sm" x-text="ai.error"></div>
                    </div>
                    
                    <div id="quotaAlertBox" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0"><i class="fas fa-exclamation-triangle text-yellow-500"></i></div>
                            <div id="quotaAlertContent" class="ml-3"></div>
                        </div>
                    </div>

                    <div class="grid gap-6 lg:grid-cols-5">
                        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm border">
                             <div class="flex justify-between items-center mb-4">
                                <h3 id="regionsTitle" class="font-semibold text-gray-700"></h3>
                                <div x-show="selectedRegion" x-cloak class="flex items-center gap-2">
                                    <span class="text-sm font-medium bg-blue-100 text-blue-700 px-3 py-1 rounded-full" x-text="'Filtered by: ' + selectedRegion"></span>
                                    <button @click="clearRegionFilter()" class="text-sm text-red-500 hover:text-red-700">&times; Clear</button>
                                </div>
                             </div>
                             <div id="highcharts-map-container" style="height: 400px;"></div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border">
                            <h3 class="font-semibold mb-4 text-gray-700">Cloud Usage</h3>
                            <div id="resourceInventory" class="space-y-4"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border" id="optimizationHub"></div>
                    
                    <div class="grid gap-6 lg:grid-cols-3">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border">
                            <h3 class="font-semibold mb-4 text-gray-700">Cost History (Last 6 Months)</h3>
                            <div class="h-80"><canvas id="costHistoryChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <h3 class="font-semibold mb-4 text-gray-700">Billing Summary (Month to Date)</h3>
                            <div class="overflow-y-auto max-h-80"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr><th class="px-6 py-3">Service</th><th class="px-6 py-3 text-right">Cost (USD)</th></tr></thead><tbody id="billingSummary"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    function dashboardApp() {
        return {
            isLoading: true,
            isModalOpen: false,
            modalTitle: '',
            modalResourceId: '',
            selectedRegion: null,
            ai: { isLoading: false, summary: '', actions: [], error: '', pulse: false },
            
            init() {
                const selectedAccountId = sessionStorage.getItem('selectedAccountId');
                if (!selectedAccountId) {
                    this.isLoading = false;
                    document.getElementById('unselectedState').classList.remove('hidden');
                    return;
                }
                this.fetchDashboardData(false); // Check cache first
            },

            fetchDashboardData(forceRefresh = false) {
                const selectedAccountId = sessionStorage.getItem('selectedAccountId');
                if (!selectedAccountId) {
                    this.isLoading = false;
                    document.getElementById('unselectedState').classList.remove('hidden');
                    document.getElementById('dashboardContent').classList.add('hidden');
                    return;
                }

                document.getElementById('unselectedState').classList.add('hidden');
                const cacheKey = `dashboardData-${selectedAccountId}`;
                const cachedData = sessionStorage.getItem(cacheKey);

                if (cachedData && !forceRefresh && !this.selectedRegion) { // Only use cache if not filtering
                    this.isLoading = false;
                    document.getElementById('dashboardContent').classList.remove('hidden');
                    this.populatePage(JSON.parse(cachedData));
                    return;
                }
                
                this.isLoading = true;
                this.ai.summary = '';
                this.ai.actions = [];
                this.ai.error = '';
                this.ai.pulse = false;
                document.getElementById('dashboardContent').classList.add('hidden');
                if (forceRefresh) sessionStorage.removeItem(cacheKey);

                let url = `/api/dashboard?accountId=${selectedAccountId}&force=true`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (!data) return;
                        if (!this.selectedRegion) {
                            sessionStorage.setItem(cacheKey, JSON.stringify(data));
                        }
                        this.populatePage(data);
                        this.generateAiSummary(); // Auto-generate summary after data fetch
                    })
                    .catch(error => {
                        console.error('Failed to fetch dashboard data:', error);
                        document.getElementById('errorMessage').textContent = 'Failed to load AWS data. Please check the backend logs or try again later.';
                        document.getElementById('errorState').classList.remove('hidden');
                    })
                    .finally(() => {
                        this.isLoading = false;
                        document.getElementById('dashboardContent').classList.remove('hidden');
                    });
            },

            generateAiSummary() {
                this.ai.isLoading = true;
                this.ai.pulse = false;
                const selectedAccountId = sessionStorage.getItem('selectedAccountId');
                fetch(`/api/advisor/summary?accountId=${selectedAccountId}`)
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to get AI summary.');
                        return res.json();
                    })
                    .then(data => { 
                        this.ai.summary = data.summary.replace(/\\n/g, '<br>');
                        this.ai.actions = data.suggestedActions || [];
                        this.ai.pulse = true; // Turn on pulse on success
                    })
                    .catch(err => { this.ai.error = err.message; })
                    .finally(() => { this.ai.isLoading = false; });
            },
            
            handleAiAction(action) {
                if (action.actionType === 'navigate') {
                    window.location.href = action.actionValue;
                } else {
                    alert(`Action: ${action.text}`);
                }
            },

            populatePage(data) {
                const account = data.selectedAccount;
                if (!account) return;
                document.getElementById('updateTime').textContent = `Updated just now`;
                this.populateKpiCards(account);
                this.populateResourceInventory(account.resourceInventory);
                this.populateOptimizationHub(account.optimizationSummary, account.costAnomalies, account.ec2Recommendations, account.ebsRecommendations, account.lambdaRecommendations);
                this.populateBillingSummary(account.billingSummary);
                this.renderCostHistoryChart(account.costHistory);
                this.renderHighchartMap(account.regionStatus);
            },

            populateKpiCards(account) {
                const kpiContainer = document.getElementById('kpi-cards');
                const costHistory = account.costHistory;
                const mtdSpend = costHistory.costs.length > 0 ? costHistory.costs[costHistory.costs.length - 1] : 0;
                const lastMonthSpend = costHistory.costs.length > 1 ? costHistory.costs[costHistory.costs.length - 2] : 0;
                const forecastedSpend = (mtdSpend / new Date().getDate()) * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();

                const kpis = [
                    { id: 'mtdSpend', title: 'Month-to-Date Spend', value: this.formatCurrency(mtdSpend), icon: 'fa-dollar-sign', color: {bg: 'bg-blue-100', text: 'text-blue-500'}, trendData: costHistory.costs },
                    { id: 'forecastedSpend', title: 'Forecasted Spend', value: this.formatCurrency(forecastedSpend), icon: 'fa-chart-line', color: {bg: 'bg-yellow-100', text: 'text-yellow-500'}, trendData: costHistory.costs },
                    { id: 'lastMonthSpend', title: 'Last Month Spend', value: this.formatCurrency(lastMonthSpend), icon: 'fa-calendar-alt', color: {bg: 'bg-gray-100', text: 'text-gray-500'}, trendData: costHistory.costs.slice(0, -1) },
                    { id: 'potentialSavings', title: 'Potential Savings', value: this.formatCurrency(account.optimizationSummary.totalPotentialSavings), icon: 'fa-piggy-bank', color: {bg: 'bg-green-100', text: 'text-green-500'}, trendData: [account.optimizationSummary.totalPotentialSavings] }
                ];
                
                kpiContainer.innerHTML = kpis.map(kpi => `
                    <div class="bg-white rounded-lg p-5 shadow-sm border kpi-card" @mouseenter="renderSparkline('sparkline-${kpi.id}', kpi.trendData, kpi.color.text)">
                        <div class="main-content">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-gray-500 text-sm font-medium">${kpi.title}</h3>
                                    <p class="text-2xl font-bold text-gray-800 mt-1">${kpi.value}</p>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg"><i class="fas ${kpi.icon} ${kpi.color.text} text-lg"></i></div>
                            </div>
                        </div>
                        <div class="sparkline-container p-2">
                            <canvas id="sparkline-${kpi.id}"></canvas>
                        </div>
                    </div>
                `).join('');
            },
            
            populateResourceInventory(inv) {
                if (!inv) return;
                const container = document.getElementById('resourceInventory');
                const resources = [
                    { n: 'VPC', i: 'fa-network-wired', v: inv.vpc, type: 'VPC' }, 
                    { n: 'ECS', i: 'fa-cubes', v: inv.ecs, type: 'ECS' }, 
                    { n: 'EC2', i: 'fa-server', v: inv.ec2, type: 'EC2 Instance' }, 
                    { n: 'Kubernetes', i: 'fa-dharmachakra', v: inv.kubernetes, type: 'EKS' }, 
                    { n: 'Lambdas', i: 'fa-bolt', v: inv.lambdas, type: 'Lambda Function' }, 
                    { n: 'EBS Volumes', i: 'fa-hdd', v: inv.ebsVolumes, type: 'EBS Volume' }
                ];
                container.innerHTML = resources.map(res => `
                    <a href="/cloudlist?service=${encodeURIComponent(res.type)}" class="flex items-center gap-4 p-2 rounded-lg hover:bg-gray-100 kpi-card">
                        <div class="bg-gray-100 rounded-lg p-3 w-12 h-12 flex items-center justify-center"><i class="fas ${res.i} text-indigo-600 fa-lg"></i></div>
                        <div>
                            <p class="font-semibold text-2xl">${res.v}</p>
                            <p class="text-xs text-gray-500">${res.n}</p>
                        </div>
                    </a>`).join('');
            },

            populateOptimizationHub(summary, anomalies, ec2Recs, ebsRecs, lambdaRecs) {
                const container = document.getElementById('optimizationHub');
                if(!summary) return;
                
                const recsHtml = (title, recs, icon, color) => {
                    if (!recs || recs.length === 0) return '';
                    return `<div class="border-t pt-4 mt-4">
                                <h4 class="font-semibold text-sm text-gray-600 mb-2 flex items-center"><i class="fas ${icon} ${color} mr-2"></i>${title} (${recs.length})</h4>
                                <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">Resource</th><th class="px-4 py-2">Recommendation</th><th class="px-4 py-2 text-right">Savings</th></tr></thead>
                                    <tbody>${recs.slice(0, 3).map(rec => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-2 font-mono text-xs">${rec.resourceId}</td>
                                            <td class="px-4 py-2">${rec.currentType} &rarr; <span class="font-semibold text-green-600">${rec.recommendedType}</span></td>
                                            <td class="px-4 py-2 text-right font-mono text-green-600">${this.formatCurrency(rec.estimatedMonthlySavings)}</td>
                                        </tr>`).join('')}
                                    </tbody>
                                </table></div>
                                ${recs.length > 3 ? `<a href="/rightsizing" class="text-sm text-indigo-600 hover:underline mt-2 inline-block">View all ${recs.length} recommendations...</a>` : ''}
                            </div>`;
                };

                const anomaliesHtml = (anomalies) => {
                     if (!anomalies || anomalies.length === 0) return '';
                     return `<div class="border-t pt-4 mt-4">
                                <h4 class="font-semibold text-sm text-gray-600 mb-2 flex items-center"><i class="fas fa-chart-area text-red-500 mr-2"></i>Cost Anomalies (${anomalies.length})</h4>
                                <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">Service</th><th class="px-4 py-2">Date</th><th class="px-4 py-2 text-right">Unexpected Spend</th></tr></thead>
                                    <tbody>${anomalies.slice(0, 3).map(a => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-2 font-semibold">${a.service}</td>
                                            <td class="px-4 py-2">${a.startDate}</td>
                                            <td class="px-4 py-2 text-right font-mono text-red-600">${this.formatCurrency(a.unexpectedSpend)}</td>
                                        </tr>`).join('')}
                                    </tbody>
                                </table></div>
                            </div>`;
                }

                container.innerHTML = `
                    <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Optimization Hub</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg text-center kpi-card"><p class="text-xs text-green-700 font-semibold uppercase">Potential Savings</p><p class="text-2xl font-bold text-green-800">${this.formatCurrency(summary.totalPotentialSavings)}</p><p class="text-xs text-green-600">per month</p></div>
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg text-center kpi-card"><p class="text-xs text-red-700 font-semibold uppercase">Critical Alerts</p><p class="text-2xl font-bold text-red-800">${summary.criticalAlertsCount}</p><p class="text-xs text-red-600">items to review</p></div>
                    </div>
                    ${recsHtml('EC2 Instance Right-Sizing', ec2Recs, 'fa-server', 'text-orange-500')}
                    ${recsHtml('EBS Volume Optimization', ebsRecs, 'fa-hdd', 'text-purple-500')}
                    ${recsHtml('Lambda Function Optimization', lambdaRecs, 'fa-bolt', 'text-yellow-500')}
                    ${anomaliesHtml(anomalies)}
                `;
            },
            
            populateBillingSummary(summary) { 
                const container = document.getElementById('billingSummary'); 
                if (!container || !summary) return; 
                if (summary.length > 0) { 
                    container.innerHTML = summary.sort((a,b) => b.monthToDateCost - a.monthToDateCost).map(item => `<tr class="border-b"><th class="px-6 py-4 font-medium">${item.serviceName}</th><td class="px-6 py-4 text-right font-mono">${this.formatCurrency(item.monthToDateCost)}</td></tr>`).join(''); 
                } else { 
                    container.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center">No billing data found.</td></tr>`; 
                } 
            },
            
            renderCostHistoryChart(costHistory) { 
                if (!costHistory || !costHistory.labels) return;
                const ctx = document.getElementById('costHistoryChart');
                if(!ctx) return;
                if (window.costHistoryChartInstance) window.costHistoryChartInstance.destroy();
                
                window.costHistoryChartInstance = new Chart(ctx, { 
                    type: 'bar', 
                    data: { 
                        labels: costHistory.labels, 
                        datasets: [{ label: 'Monthly Cost', data: costHistory.costs, backgroundColor: 'rgba(79, 70, 229, 0.8)' }] 
                    }, 
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Cost: ${this.formatCurrency(context.parsed.y)}`
                                }
                            }
                        }, 
                        scales: { y: { beginAtZero: true, ticks: { callback: value => this.formatCurrency(value) } } } 
                    } 
                }); 
            },
            
            renderHighchartMap(regionStatus) {
                if (!regionStatus || !document.getElementById('highcharts-map-container')) return;
                const statusColors = { 'ACTIVE': '#3b82f6', 'SEMI_ACTIVE': '#ef4444', 'SUSTAINABLE': '#22c55e', 'NON_ACTIVE': '#6b7280' };
                const regionPoints = regionStatus.map(r => ({ name: `${r.regionId} (${r.status})`, lat: r.lat, lon: r.lon, color: statusColors[r.status] || '#6b7280', id: r.regionId }));
                
                Highcharts.mapChart('highcharts-map-container', {
                    chart: { map: 'custom/world', backgroundColor: '#f8fafc' },
                    title: { text: null }, credits: { enabled: false },
                    mapNavigation: { enabled: true, buttonOptions: { verticalAlign: 'bottom' } },
                    tooltip: { headerFormat: '', pointFormat: '<b>{point.name}</b>' },
                    plotOptions: {
                        mappoint: {
                            point: {
                                events: {
                                    click: (e) => {
                                        this.filterByRegion(e.point.id);
                                    }
                                }
                            }
                        }
                    },
                    series: [{ name: 'World', color: '#e5e7eb', states: { hover: { color: '#d1d5db' } } }, 
                             { type: 'mappoint', name: 'AWS Regions', data: regionPoints, marker: { lineWidth: 1, lineColor: '#ffffff' } }]
                });
            },

            renderSparkline(canvasId, data, color) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                // If a chart instance already exists on this canvas, destroy it first
                if (window[canvasId+'_instance']) {
                    window[canvasId+'_instance'].destroy();
                }

                window[canvasId+'_instance'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map((_, i) => i),
                        datasets: [{
                            data: data,
                            borderColor: color.replace('text', 'border').replace('-500', '-600'), // Use a slightly darker color for the line
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: color.replace('text', 'bg').replace('-500', '-100') // Use a lighter bg color
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { x: { display: false }, y: { display: false } },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            },

            filterByRegion(regionId) {
                this.selectedRegion = regionId;
                alert(`Dashboard view filtered by region: ${regionId}.\n(Note: This is a UI demonstration. Backend filtering is not implemented.)`);
            },

            clearRegionFilter() {
                this.selectedRegion = null;
                this.fetchDashboardData(true);
            },

            formatCurrency(num) { return '$' + (num != null ? num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'); },
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the dashboard app
        Alpine.data('dashboardApp', dashboardApp);
    });
    </script>
</body>
</html>