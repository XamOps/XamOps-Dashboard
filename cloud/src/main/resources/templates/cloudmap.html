<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - Cloudmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #cy {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Behind the info panel */
        }
        #info-panel {
            transition: transform 0.3s ease-in-out;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="flex h-screen bg-white">
    <div th:replace="~{fragments/_sidebar :: sidebar}"></div>

    <main class="flex-1 flex flex-col">
        <header class="h-16 flex items-center justify-between border-b bg-white px-6">
            <h1 class="text-xl font-semibold text-gray-800">Cloudmap - Infrastructure Visualization</h1>
        </header>

        <div class="flex-1 relative" id="cloudmap-container">
            <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-white z-20">
                <i class="fas fa-spinner fa-spin fa-3x text-indigo-600"></i>
            </div>
            
            <div id="cy"></div>

            <div id="info-panel" class="absolute top-0 right-0 h-full w-96 bg-white shadow-lg p-6 border-l transform translate-x-full">
                <button id="close-panel-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <div id="info-content">
                    </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const loadingSpinner = document.getElementById('loading-spinner');
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    const closePanelBtn = document.getElementById('close-panel-btn');
    let cy;

    closePanelBtn.addEventListener('click', () => infoPanel.classList.add('translate-x-full'));

    fetch('/api/cloudmap/graph-data')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            loadingSpinner.style.display = 'none';
            renderGraph(data);
        })
        .catch(error => {
            console.error('Error fetching graph data:', error);
            loadingSpinner.innerHTML = '<div class="text-center"><i class="fas fa-exclamation-triangle fa-2x text-red-500"></i><p class="mt-2 text-red-600 font-semibold">Could not load graph data.</p><p class="text-xs text-gray-500">Please check backend logs for details.</p></div>';
        });

    function renderGraph(graphData) {
        // --- Define our color palette ---
        const colors = {
            green: '#22C55E', // Green 500
            red: '#EF4444',   // Red 500
            amber: '#F59E0B', // Amber 500
            grey: '#6B7281',  // Gray 500
            blue: '#3B82F6'   // Blue 500
        };

        cy = cytoscape({
            container: document.getElementById('cy'),
            elements: graphData,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)', 'width': '60px', 'height': '60px',
                        'font-size': '10px', 'text-valign': 'bottom', 'text-halign': 'center',
                        'color': '#fff', 'text-outline-color': '#888', 'text-outline-width': 2,
                        'transition-property': 'background-color, border-color, border-width',
                        'transition-duration': '0.3s'
                    }
                },
                {
                    selector: 'edge',
                    style: { 'width': 2, 'line-color': '#ccc', 'target-arrow-color': '#ccc', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                },
                {
                    selector: ':parent',
                    style: { 'background-opacity': 0.2, 'border-color': '#666', 'border-width': 1, 'text-valign': 'top', 'font-weight': 'bold' }
                },
                // --- Static Node Shapes and Base Colors ---
                { selector: 'node[type="EC2 Instance"]',   style: { 'shape': 'ellipse',       'background-color': colors.grey } },
                { selector: 'node[type="RDS Instance"]',   style: { 'shape': 'barrel',        'background-color': colors.grey } },
                { selector: 'node[type="Load Balancer"]',  style: { 'shape': 'round-octagon', 'background-color': colors.blue } },
                { selector: 'node[type="S3 Bucket"]',      style: { 'shape': 'round-rectangle', 'width': '80px', 'background-color': colors.green } },
                { selector: 'node[type="Security Group"]', style: { 'shape': 'diamond',       'width':'25px', 'height':'25px', 'background-color': '#DD4444' } },
                { selector: 'node[type="VPC"]',            style: { 'background-color': '#232F3E', 'background-opacity': 0.3 } },
                { selector: 'node[type="Subnet"]',         style: { 'background-color': '#527FFF', 'background-opacity': 0.2 } },

                // --- DYNAMIC STYLES based on 'displayState' ---
                {
                    selector: 'node[displayState="running"], node[displayState="available"], node[displayState="active"]',
                    style: { 'background-color': colors.green }
                },
                {
                    selector: 'node[displayState="stopped"], node[displayState="terminated"]',
                    style: { 'background-color': colors.red }
                },
                {
                    selector: 'node[displayState*="pending"], node[displayState*="stopping"], node[displayState*="creating"]',
                    style: {
                        'background-color': colors.amber,
                        'border-color': colors.amber,
                        'border-width': '4px',
                        'border-style': 'double'
                    }
                }
            ],
            layout: {
                name: 'cose',
                idealEdgeLength: 100, nodeOverlap: 20, refresh: 20, fit: true, padding: 30,
                randomize: false, componentSpacing: 100, nodeRepulsion: 400000,
                edgeElasticity: 100, nestingFactor: 5, gravity: 80, numIter: 1000,
                initialTemp: 200, coolingFactor: 0.95, minTemp: 1.0
            }
        });

        cy.on('tap', 'node', evt => displayNodeInfo(evt.target.data()));
        cy.on('tap', evt => { if (evt.target === cy) infoPanel.classList.add('translate-x-full'); });
    }

    function displayNodeInfo(data) {
        let contentHtml = `<h2 class="text-xl font-bold mb-1">${data.label}</h2>
                           <p class="text-sm text-gray-500 font-mono mb-4">${data.id}</p>
                           <div class="space-y-2 text-sm">`;

        const internalKeys = ['id', 'label', 'parent'];
        for (const [key, value] of Object.entries(data)) {
            if (!internalKeys.includes(key) && value) {
                contentHtml += `<div class="flex justify-between border-b pb-1">
                                    <span class="font-semibold text-gray-600">${key.replace(/([A-Z])/g, ' $1').trim()}</span>
                                    <span class="font-mono text-gray-800 text-right">${value}</span>
                                </div>`;
            }
        }

        contentHtml += `</div>`;
        infoContent.innerHTML = contentHtml;
        infoPanel.classList.remove('translate-x-full');
    }
});
</script>

</body>
</html>