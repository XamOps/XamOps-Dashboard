<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamOps - CloudK8s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --k8s-gradient: linear-gradient(135deg, #326ce5 0%, #1e3a8a 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(229, 231, 235, 0.8);
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        [x-cloak] { display: none !important; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .header-gradient { background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); }
        .table-enhanced thead { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .table-enhanced tr:hover { background: rgba(102, 126, 234, 0.05); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #326ce5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal-content { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); }
        .code-block { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; max-height: 60vh; overflow-y: auto; }
        .status-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .sortable-header { cursor: pointer; }
        .sortable-header:hover { color: #326ce5; }
    </style>
</head>
<body class="bg-gray-50">

<div class="flex">
    <aside class="fixed top-0 left-0 h-screen w-64 bg-white border-r border-gray-200">
        <div th:replace="~{fragments/_sidebar :: sidebar}"></div>
    </aside>

    <div class="ml-64 flex-1">
        <main class="flex-1 flex flex-col min-h-screen" x-data="cloudK8s()" @destroy="cleanup()">
            <header class="header-gradient h-20 flex items-center justify-between px-8 sticky top-0 z-20">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-dharmachakra text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">CloudK8s Dashboard</h1>
                        <p class="text-sm text-gray-600">Monitor your EKS clusters and workloads</p>
                    </div>
                </div>
                <button @click="view === 'clusters' ? fetchClusters(true) : navigateToClusters()" class="px-4 py-2 text-sm font-semibold rounded-lg bg-white border hover:bg-gray-50">
                    <span x-show="view === 'clusters'">Refresh Now</span>
                    <span x-show="view !== 'clusters'"><i class="fas fa-arrow-left mr-2"></i>Back to Clusters</span>
                </button>
            </header>

            <div class="flex-1 p-4 md:p-8 space-y-8">
                <div x-show="view === 'clusters'" class="glass-card rounded-2xl p-6 md:p-8 fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">K8s Clusters</h2>
                    <div x-show="isLoading.clusters" class="text-center py-12"><div class="loading-spinner mx-auto"></div></div>

                    <table x-show="!isLoading.clusters && clusters.length > 0" x-cloak class="w-full text-sm table-enhanced rounded-lg overflow-hidden">
                        <thead class="text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-4 text-left font-bold">Name / ID</th>
                                <th class="px-6 py-4 text-left font-bold hidden md:table-cell">Account / Region</th>
                                <th class="px-6 py-4 text-left font-bold">Connection</th>
                                <th class="px-6 py-4 text-center font-bold">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="cluster in clusters" :key="cluster.name">
                                <tr>
                                    <td class="px-6 py-4 font-semibold text-gray-800" x-text="cluster.name"></td>
                                    <td class="px-6 py-4 hidden md:table-cell"><span x-text="selectedAccountId"></span> / <span x-text="cluster.region"></span></td>
                                    <td class="px-6 py-4">
                                        <span class="status-badge" :class="cluster.connected ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'" x-text="cluster.connected ? 'Connected' : 'Agent Not Detected'"></span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <button @click="navigateToDetails(cluster)" class="px-4 py-2 text-xs font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                                            Details
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div x-show="view === 'details' && selectedCluster" x-cloak class="fade-in space-y-8">
                    <div class="glass-card rounded-2xl p-6 md:p-8 mb-6" x-show="clusterUsage">
                        <h3 class="text-lg font-semibold mb-2">Cluster Usage Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm font-medium text-gray-600">CPU Usage</p>
                                <p class="text-xl font-bold" x-text="clusterUsage.cpuUsage.toFixed(2) + ' %'"></p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600">Memory Usage</p>
                                <p class="text-xl font-bold" x-text="clusterUsage.memoryUsage.toFixed(2) + ' %'"></p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600">Nodes</p>
                                <p class="text-xl font-bold" x-text="clusterUsage.nodeCount"></p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600">Pods</p>
                                <p class="text-xl font-bold" x-text="clusterUsage.podCount"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">CPU Usage</h4>
                                <div class="h-64">
                                    <canvas id="cpuUsageChart"></canvas>
                                </div>
                            </div>
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Memory Usage</h4>
                                <div class="h-64">
                                    <canvas id="memoryUsageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 md:p-8">
                        </div>
                </div>
            </div>

            <div x-show="isDetailsModalOpen" x-cloak class="modal-overlay fixed inset-0 flex items-center justify-center z-50" @click.away="isDetailsModalOpen = false">
                <div class="modal-content rounded-2xl p-8 w-full max-w-3xl mx-4 max-h-[90vh] flex flex-col" @click.stop>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4" x-text="`${selectedResource.type} Details`"></h3>
                    <div class="flex-1 overflow-y-auto">
                        <pre class="code-block" x-text="selectedResource.details"></pre>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button @click="isDetailsModalOpen = false" class="px-6 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50">Close</button>
                    </div>
                </div>
            </div>
            
            <div x-show="isLogsModalOpen" x-cloak class="modal-overlay fixed inset-0 flex items-center justify-center z-50" @click.away="isLogsModalOpen = false">
                <div class="modal-content rounded-2xl p-8 w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col" @click.stop>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4" x-text="`Logs for ${selectedPod.name}`"></h3>
                    <div class="flex-1 overflow-y-auto">
                        <pre class="code-block" x-text="podLogs"></pre>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button @click="isLogsModalOpen = false" class="px-6 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50">Close</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
function cloudK8s() {
    return {
        // --- STATE MANAGEMENT ---
        view: 'clusters', // 'clusters' or 'details'
        isLoading: { clusters: true, usage: true },
        clusters: [],
        selectedCluster: null,
        activeTab: 'nodes',
        selectedAccountId: null,
        pollingInterval: null,
        isDetailsModalOpen: false, isLogsModalOpen: false,
        selectedResource: { type: '', details: '' },
        selectedPod: { name: '' }, podLogs: '',
        searchTerm: '',
        sortColumn: 'name', sortDirection: 'asc',
        clusterUsage: null,

        // --- INITIALIZATION & NAVIGATION ---
        init() {
            this.selectedAccountId = sessionStorage.getItem('selectedAccountId');
            if (!this.selectedAccountId) { 
                this.isLoading.clusters = false; return; 
            }
            this.fetchClusters();
        },
        cleanup() { if (this.pollingInterval) clearInterval(this.pollingInterval); },
        navigateToClusters() {
            this.view = 'clusters';
            this.selectedCluster = null;
            this.cleanup();
        },
        async navigateToDetails(cluster) {
            if (!cluster.connected) {
                alert('Container Insights agent is not detected for this cluster. Please deploy the agent to see performance data.');
                return;
            }
            this.selectedCluster = cluster;
            this.view = 'details';
            await this.fetchClusterUsage(); // Wait for data
            this.renderUsageCharts(); // Then render charts

            // Optional: Start polling for live data
            this.pollingInterval = setInterval(() => {
                this.fetchClusterUsage();
            }, 30000);
        },
        
        // --- DATA FETCHING ---
        async fetchClusterUsage() {
            if (!this.selectedCluster) return;
            this.isLoading.usage = true;
            const { name, region } = this.selectedCluster;
            
            try {
                const response = await fetch(`/api/k8s/clusters/usage?accountId=${this.selectedAccountId}&clusterName=${name}&region=${region}`, {
                    method: 'POST'
                });
                const data = await response.json();
                this.clusterUsage = data;
            } catch (err) {
                console.error('Failed to fetch cluster usage', err);
                this.clusterUsage = null;
            } finally {
                this.isLoading.usage = false;
            }
        },
        fetchClusters(force = false) {
            if (force) {
                console.log('Force refreshing cluster data...');
            }
            this.isLoading.clusters = true;
            fetch(`/api/k8s/clusters?accountId=${this.selectedAccountId}`)
                .then(res => res.json())
                .then(data => { this.clusters = data; })
                .catch(err => console.error('Failed to fetch clusters', err))
                .finally(() => this.isLoading.clusters = false);
        },

        // --- NEW: Chart Rendering ---
        renderUsageCharts() {
            if (!this.clusterUsage) return;

            if (window.cpuChartInstance) window.cpuChartInstance.destroy();
            if (window.memChartInstance) window.memChartInstance.destroy();

            const cpuCtx = document.getElementById('cpuUsageChart').getContext('2d');
            window.cpuChartInstance = new Chart(cpuCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{
                        data: [this.clusterUsage.cpuUsage, 100 - this.clusterUsage.cpuUsage],
                        backgroundColor: ['#326ce5', '#e5e7eb'],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });

            const memCtx = document.getElementById('memoryUsageChart').getContext('2d');
            window.memChartInstance = new Chart(memCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{
                        data: [this.clusterUsage.memoryUsage, 100 - this.clusterUsage.memoryUsage],
                        backgroundColor: ['#667eea', '#e5e7eb'],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });
        },

        // --- DETAILS & LOGS MODAL LOGIC ---
        showDetails(resource, type) {
            this.selectedResource.type = type;
            this.selectedResource.details = JSON.stringify(resource, null, 2);
            this.isDetailsModalOpen = true;
        },
        showLogs(pod) {
            this.selectedPod = pod;
            this.podLogs = 'Loading logs...';
            this.isLogsModalOpen = true;
            
            const { name, region } = this.selectedCluster;
            fetch(`/api/k8s/pods/logs?accountId=${this.selectedAccountId}&clusterName=${name}&region=${region}&namespace=${this.selectedNamespace}&podName=${pod.name}`, {
                method: 'POST'
            })
            .then(res => res.text())
            .then(data => { this.podLogs = data; })
            .catch(err => {
                console.error('Failed to fetch logs', err);
                this.podLogs = 'Error fetching logs.';
            });
        }
    }
}
</script>

</body>
</html>