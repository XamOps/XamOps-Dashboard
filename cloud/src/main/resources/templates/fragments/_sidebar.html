<!-- src/main/resources/templates/fragments/_sidebar.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body>
<div th:fragment="sidebar" class="h-full flex flex-col bg-white">
    <!-- Logo -->
    <div class="flex items-center justify-center h-16 border-b">
        <a href="/" class="text-2xl font-bold text-indigo-600">XamOps</a>
    </div>

    <!-- Account Switcher -->
    <div x-data="{
        open: false,
        accounts: [],
        selectedAccount: null,
        searchTerm: '',
        init() {
            this.fetchAccounts();
        },
        fetchAccounts() {
            fetch('/api/account-manager/accounts')
                .then(res => res.json())
                .then(data => {
                    this.accounts = data.filter(acc => acc.status === 'CONNECTED');
                    const selectedId = sessionStorage.getItem('selectedAccountId');
                    if (selectedId) {
                        this.selectedAccount = this.accounts.find(acc => acc.id == selectedId);
                    }
                    if (!this.selectedAccount && this.accounts.length > 0) {
                        this.selectedAccount = this.accounts[0];
                        sessionStorage.setItem('selectedAccountId', this.selectedAccount.id);
                    }
                })
                .catch(err => console.error('Failed to fetch accounts:', err));
        },
        selectAccount(account) {
            this.selectedAccount = account;
            sessionStorage.setItem('selectedAccountId', account.id);
            this.open = false;
            window.location.reload(); // Reload the page to fetch data for the new account
        },
        get filteredAccounts() {
            if (this.searchTerm === '') {
                return this.accounts;
            }
            return this.accounts.filter(account => {
                return account.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                       account.id.toLowerCase().includes(this.searchTerm.toLowerCase());
            });
        }
    }" class="p-3 border-b flex-shrink-0">
        
        <div @click="open = !open" 
             class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 cursor-pointer relative">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-sm mr-3" 
                     x-text="selectedAccount ? selectedAccount.name.charAt(0).toUpperCase() : 'X'"></div>
                <div>
                    <span class="text-sm font-semibold text-gray-800" 
                          x-text="selectedAccount ? selectedAccount.name : 'Select Account'"></span>
                    <p class="text-xs text-gray-500" 
                       x-text="selectedAccount ? selectedAccount.id : 'No account selected'"></p>
                </div>
            </div>
            <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" 
               :class="{ 'rotate-180': open }"></i>
            
            <div x-show="open" 
                 x-transition
                 @click.outside="open = false" 
                 x-cloak
                 class="absolute left-0 right-0 mt-1 mx-2 bg-white border border-gray-200 rounded-md shadow-lg z-50 overflow-hidden">
                <div class="p-2">
                    <input type="text" x-model="searchTerm" placeholder="Search accounts..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="py-1 max-h-60 overflow-y-auto">
                    <template x-for="account in filteredAccounts" :key="account.dbId">
                        <div @click.stop="selectAccount(account)"
                             class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 cursor-pointer">
                            <span class="font-medium" x-text="account.name"></span>
                            <span class="text-xs text-gray-500 ml-auto" x-text="account.id"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <nav class="flex-1 px-2 py-3 space-y-1 text-sm overflow-y-auto sidebar-scroll">
        <a href="/" th:classappend="${#httpServletRequest.getRequestURI() == '/' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}" class="flex items-center gap-3 rounded-md px-3 py-2.5 font-semibold transition-colors duration-150">
            <i class="fas fa-tachometer-alt fa-fw w-5 text-center"></i>
            <span>Dashboard</span>
        </a>
        
        <div x-data="{ open: [[${#strings.contains(#httpServletRequest.getRequestURI(), 'cloudk8s') || #strings.contains(#httpServletRequest.getRequestURI(), 'cloudlist') || #strings.contains(#httpServletRequest.getRequestURI(), 'cloudmap')}]] }">
            <button @click="open = !open" class="w-full flex items-center justify-between gap-3 rounded-md px-3 py-2.5" th:classappend="${#strings.contains(#httpServletRequest.getRequestURI(), 'cloudk8s') || #strings.contains(#httpServletRequest.getRequestURI(), 'cloudlist') || #strings.contains(#httpServletRequest.getRequestURI(), 'cloudmap') ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:bg-gray-100'}">
                <div class="flex items-center gap-3"><i class="fas fa-cloud fa-fw w-5 text-center"></i><span class="font-semibold">Cloudview</span></div>
                <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" :class="open && 'rotate-180'"></i>
            </button>
            <div x-show="open" x-cloak class="pl-7 py-1 space-y-1" x-transition>
                <a href="/cloudk8s" th:classappend="${#httpServletRequest.getRequestURI() == '/cloudk8s' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">CloudK8s <span class="text-xs bg-blue-100 text-blue-600 font-semibold px-2 py-0.5 rounded-full ml-2">BETA</span></a>
                <a href="/cloudlist" th:classappend="${#httpServletRequest.getRequestURI() == '/cloudlist' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Cloudlist</a>
                <a href="/cloudmap" th:classappend="${#httpServletRequest.getRequestURI() == '/cloudmap' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Cloudmap</a>
            </div>
        </div>

        <div x-data="{ open: [[${#strings.contains(#httpServletRequest.getRequestURI(), 'finops') || #strings.contains(#httpServletRequest.getRequestURI(), 'cost') || #strings.contains(#httpServletRequest.getRequestURI(), 'waste') || #strings.contains(#httpServletRequest.getRequestURI(), 'rightsizing') || #strings.contains(#httpServletRequest.getRequestURI(), 'reservation')}]] }">
            <button @click="open = !open" class="w-full flex items-center justify-between gap-3 rounded-md px-3 py-2.5" th:classappend="${#strings.contains(#httpServletRequest.getRequestURI(), 'waste') || #strings.contains(#httpServletRequest.getRequestURI(), 'rightsizing') || #strings.contains(#httpServletRequest.getRequestURI(), 'finops') || #strings.contains(#httpServletRequest.getRequestURI(), 'reservation') || #strings.contains(#httpServletRequest.getRequestURI(), 'cost') ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:bg-gray-100'}">
                <div class="flex items-center gap-3"><i class="fas fa-cogs fa-fw w-5 text-center"></i><span class="font-semibold">Optimization</span></div>
                <i class="fas fa-chevron-down text-xs transition-transform" :class="open && 'rotate-180'"></i>
            </button>
            <div x-show="open" x-cloak class="pl-7 py-1 space-y-1" x-transition>
                <a href="/finops" th:classappend="${#httpServletRequest.getRequestURI() == '/finops' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">FinOps Report</a>
                <a href="/cost" th:classappend="${#httpServletRequest.getRequestURI() == '/cost' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Costs overview</a>
                <a href="/waste" th:classappend="${#httpServletRequest.getRequestURI() == '/waste' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Waste</a>
                <a href="/rightsizing" th:classappend="${#httpServletRequest.getRequestURI() == '/rightsizing' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Rightsizing</a>
                <a href="/reservation" th:classappend="${#httpServletRequest.getRequestURI() == '/reservation' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Reservation</a>
                <a href="#" class="block rounded-md px-3 py-2 text-gray-400 cursor-not-allowed font-medium">Savings</a>
            </div>
        </div>

        <div x-data="{ open: [[${#strings.contains(#httpServletRequest.getRequestURI(), 'security') || #strings.contains(#httpServletRequest.getRequestURI(), 'performance') || #strings.contains(#httpServletRequest.getRequestURI(), 'alerts')}]] }">
            <button @click="open = !open" class="w-full flex items-center justify-between gap-3 rounded-md px-3 py-2.5" th:classappend="${#strings.contains(#httpServletRequest.getRequestURI(), 'security') || #strings.contains(#httpServletRequest.getRequestURI(), 'performance') || #strings.contains(#httpServletRequest.getRequestURI(), 'alerts') ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:bg-gray-100'}">
                <div class="flex items-center gap-3"><i class="fas fa-shield-alt fa-fw w-5 text-center"></i><span class="font-semibold">Cloudguard</span></div>
                <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" :class="open && 'rotate-180'"></i>
            </button>
            <div x-show="open" x-cloak class="pl-7 py-1 space-y-1" x-transition>
                <a href="/security" th:classappend="${#httpServletRequest.getRequestURI() == '/security' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Security</a>
                <a href="/performance" th:classappend="${#httpServletRequest.getRequestURI() == '/performance' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Performance</a>
                <a href="/cloudguard/alerts" th:classappend="${#httpServletRequest.getRequestURI() == '/cloudguard/alerts' ? 'text-indigo-600 font-bold' : 'text-gray-500'}" class="block rounded-md px-3 py-2 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Alerts</a>
            </div>
        </div>
        
        <a href="/account-manager" th:classappend="${#httpServletRequest.getRequestURI() == '/account-manager' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}" class="flex items-center gap-3 rounded-md px-3 py-2.5 font-semibold transition-colors duration-150">
            <i class="fas fa-users-cog fa-fw w-5 text-center"></i>
            <span>Account Manager</span>
        </a>
    </nav>
</div>
</body>
</html>
