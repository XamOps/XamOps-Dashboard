<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>XamOps - GCP Waste Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <div th:replace="~{fragments/_sidebar :: sidebar}"></div>
        <main class="flex-1 flex flex-col p-6" x-data="gcpWaste()">
            <header class="flex-shrink-0 mb-6">
                <h1 class="text-2xl font-bold text-gray-800">GCP Waste Management</h1>
            </header>
            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <p class="text-sm font-medium text-gray-500">Total Potential Savings</p>
                     <p class="text-3xl font-bold text-green-600" x-text="`$${totalSavings.toFixed(2)}`"></p>
                 </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <p class="text-sm font-medium text-gray-500">Wasted Resources</p>
                     <p class="text-3xl font-bold text-red-600" x-text="wasteItems.length"></p>
                 </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Savings by Category</h3>
                    <div class="h-48">
                        <canvas id="savingsChart"></canvas>
                    </div>
                 </div>
            </div>

            <div class="flex-1 w-full bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto h-full">
                     <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Resource Name</th>
                                <th scope="col" class="px-6 py-3">Type</th>
                                <th scope="col" class="px-6 py-3">Location</th>
                                <th scope="col" class="px-6 py-3 text-right">Potential Monthly Savings (USD)</th>
                            </tr>
                        </thead>
                         <tbody>
                            <template x-if="isLoading">
                                <tr class="bg-white border-b animate-pulse" x-ref="loading" x-init="$el.setAttribute('x-for', 'i in 5')">
                                    <td class="px-6 py-4" colspan="4"><div class="h-4 bg-gray-200 rounded"></div></td>
                                </tr>
                            </template>
                            <template x-for="item in wasteItems" :key="item.resourceName">
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 font-medium text-gray-900" x-text="item.resourceName"></td>
                                    <td class="px-6 py-4" x-text="item.type"></td>
                                    <td class="px-6 py-4" x-text="item.location"></td>
                                    <td class="px-6 py-4 text-right font-medium text-green-600" x-text="`$${item.monthlySavings.toFixed(2)}`"></td>
                                </tr>
                            </template>
                             <template x-if="!isLoading && wasteItems.length === 0">
                                <tr>
                                    <td colspan="4" class="text-center py-12 text-gray-500">No wasted resources found. Great job!</td>
                                </tr>
                            </template>
                        </tbody>
                     </table>
                </div>
            </div>
        </main>
    </div>
    <script>
        function gcpWaste() {
            return {
                isLoading: true,
                accountId: sessionStorage.getItem('selectedAccountId'),
                wasteItems: [],
                savingsChart: null,
                get totalSavings() {
                    return this.wasteItems.reduce((sum, item) => sum + item.monthlySavings, 0);
                },
                init() {
                    this.fetchWasteReport();
                },
                fetchWasteReport() {
                    this.isLoading = true;
                    fetch(`/api/gcp/optimization/waste-report?accountId=${this.accountId}`)
                        .then(res => res.json())
                        .then(data => { 
                            this.wasteItems = data; 
                            this.renderSavingsChart();
                        })
                        .catch(err => console.error('Failed to load GCP waste report:', err))
                        .finally(() => this.isLoading = false);
                },
                renderSavingsChart() {
                    const savingsByCategory = this.wasteItems.reduce((acc, resource) => {
                        acc[resource.type] = (acc[resource.type] || 0) + resource.monthlySavings;
                        return acc;
                    }, {});

                    const labels = Object.keys(savingsByCategory);
                    const data = Object.values(savingsByCategory);

                    const ctx = document.getElementById('savingsChart');
                    if (!ctx) return;

                    if (this.savingsChart) {
                        this.savingsChart.destroy();
                    }
                    
                    this.savingsChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'],
                                borderWidth: 0,
                                hoverOffset: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { boxWidth: 12, font: { size: 11 } }
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
